@using Microsoft.AspNetCore.Http
@using System.Security.Claims
@inject IHttpContextAccessor HttpContextAccessor
@model MO.GauravProfile.Step2MO
@{
    ViewData["Title"] = "Step2";
    Layout = "~/Views/Shared/_LayoutIn.cshtml";
    var user = HttpContextAccessor.HttpContext.User;
    var isAuthenticated = user.Identity.IsAuthenticated;
    var district = user.FindFirst("DistrictName")?.Value;
    var nonce = Context.Items["CSPNonce"]?.ToString();
}
<div class="card radius-10 shadow-sm">
    <div class="card-body">

        <h4 class="text-center fw-bold">पंच गौरव कार्यक्रम</h4>
        <h5 class="text-center">वित्तीय वर्ष 2025–26</h5>
        <h6 class="text-center text-primary">District - @district</h6>

        <div class="my-3">
            @await Html.PartialAsync("_ProgressBar", new MO.GauravProfile.Step1MO
            {
                CurrentStep = Model.CurrentStep,
                        GauravGuid = Model.GauravGuid
                        })
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" value="@Model.GauravGuid" id="hiddenGauravGuid" />
        <input type="hidden" id="hiddenrowId" />

        <!-- Dynamic Form -->
        <div id="dynamicFormContainer" class="p-4 bg-light border-start border-3 border-primary rounded shadow-sm mb-4">
            @* JS will generate full form *@
        </div>

        <!-- Saved Records Title -->
        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
            <h5 class="fw-bold text-secondary"><i class="bi bi-folder-check"></i> Saved Records</h5>
        </div>

        <!-- Saved Records Table -->
        <div class="table-responsive shadow-sm">
            <table class="table table-bordered table-hover align-middle" id="savedTable">
                <thead class="table-success text-center">
                    <tr>
                        <th>#</th>
                        <th>गतिविधि</th>
                        <th>नाम</th>
                        <th>कूल प्रस्तावित व्यय</th>
                        <th>नोडल विभाग का व्यय</th>
                        <th>MPLAD, MLALAD से व्यय</th>
                        <th>CSR मद से व्यय</th>
                        <th>अन्य मद द्वारा व्यय</th>
                        <th>पंच-गौरव से बजट आवश्यकता</th>
                        <th>कार्य योजना</th>
                        <th>समय सीमा</th>
                        <th style="width:100px;">कार्यवाही</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end mt-4">
            <a class="btn btn-outline-warning px-4 m-2" asp-action="Step1"
               asp-controller="Profile"
               asp-route-guid="@Model.GauravGuid">
                <i class="fa fa-arrow-circle-left"></i> Back
            </a>

            <a class="btn btn-success px-4 fw-semibold m-2"
               asp-action="Step3"
               asp-controller="Profile"
               asp-route-guid="@Model.GauravGuid">
                Save & Next <i class="fa fa-arrow-circle-right"></i>
            </a>
        </div>

    </div>
</div>


<script nonce="@nonce">
    const questions = @Html.Raw(Json.Serialize(Model.mainquestion))
    const activityList = @Html.Raw(Json.Serialize(ViewBag.ActivityTypes))  // FIXED    
    const savedRows = @Html.Raw(Json.Serialize(ViewBag.List))
    const gauravGuid = '@Model.GauravGuid';
</script>

<script nonce="@nonce" src="~/custom/gauravprofile _step2.js" asp-append-version="true"></script>  @* External JS file *@
<script nonce="@nonce">
    $(document).on("click", "#btnSaveStep2", function () {
        saveStep2();
    });
    $(document).on("click", ".btn-edit", function () {
        let rowId = $(this).closest("tr").data("rowid");
        editRow(rowId);
    });
    $(document).on("click", ".btn-delete", function () {
        let rowId = $(this).closest("tr").data("rowid");
        deleteRow(rowId);
    });
</script>
<script nonce="@nonce">
        $(document).on('focus', '.datepicker', function () {
        $(this).datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true,
            todayHighlight: true
        });
    });
   
        function getVal(id) {
            var el = document.getElementById(id);
            return el && el.value ? parseFloat(el.value) : 0;
        }

        function calculatePanchGaurav() {

            var totalProposed = getVal('TotalProposed');
            var nodal = getVal('NodalAmount');
            var mplad = getVal('MPLADAmount');
            var csr = getVal('CSRAmount');
            var other = getVal('OtherAmount');

            var totalExpense = nodal + mplad + csr + other;
            var panchGaurav = totalProposed - totalExpense;

            // if (panchGaurav < 0) {
            //     panchGaurav = 0;
            // }

            var pg = document.getElementById('PanchGauravAmount');
            if (pg) {
                pg.value = panchGaurav;
            }
        }

        // Event listeners
        [
            'TotalProposed',
            'NodalAmount',
            'MPLADAmount',
            'CSRAmount',
            'OtherAmount'
        ].forEach(function (id) {

            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', calculatePanchGaurav);
                el.addEventListener('change', calculatePanchGaurav);
            }
        });

    });

   
</script>